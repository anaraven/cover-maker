<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://unpkg.com/tachyons@4.10.0/css/tachyons.min.css"/>
  <link rel="stylesheet" href="cover.css">
  <title>Cover</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.23/jquery-ui.min.js"></script>
</head>
<body>
<div class="all" id="all">
  <div class="face" id="back" onclick="showBlock(this,'back-tab')">
    <canvas id="back_src"></canvas>
  </div>
  <div class="center" id="title" onclick="showBlock(this,'center-tab')" style="width: 20mm;">
    Title of the book
  </div>
  <div class="face" id="front" onclick="showBlock(this,'front-tab')">
    <canvas id="source"></canvas>
  </div>
</div>

<div class="data w3-border">
<div class="w3-bar w3-border-bottom w3-light-grey intronav">
  <button class="w3-bar-item w3-button" onclick="showBlock(this,'front-tab')">Front</button>
  <button class="w3-bar-item w3-button" onclick="showBlock(this,'center-tab')">Center</button>
  <button class="w3-bar-item w3-button" onclick="showBlock(this,'back-tab')">Back</button>
</div>
<fieldset class="col measure" id="front-tab">
  <legend class="f4 ph1">Front</legend>
  <div><label class="db fw6 lh-copy f6" for="front_file"> Image</label>
  <input type="file" id="front_file" name="files[]" onchange="fileSelect(this,'front')"/></div>
  <div><label class="db fw6 lh-copy f6" for="front_bg"> Background</label>
  <input type="color" id="front_bg" value="#ffffff" onchange="changeAttribute(this,'front','background')"/>
  <a href="#" onclick="createImage('source')">Pick Color</a></div>
  <div><label class="db fw6 lh-copy f6" for="front_wd"> Width</label>
  <input type="text" id="front_wd" value="100mm" onchange="changeAttribute(this,'front','width'); changeAttribute(this,'back','width')"/></div>
  <div><label class="db fw6 lh-copy f6" for="front_height"> Height</label>
  <input type="text" id="front_height" value="131mm" onchange="changeAttribute(this,'all','height')"/></div>
</fieldset>
<fieldset class="col measure" id="center-tab" style="display: none;">
  <legend class="f4 ph1">Center</legend>
  <div class="dt dt--fixed"><div class="dtc">
  <div><label class="db fw6 lh-copy f6" for="back_file">Text</label>
  <input type="text" value="Title of the Book" onchange="updateTitle(this)"></div>
  <div><label class="db fw6 lh-copy f6" for="back_file">Background</label>
  <input type="color" value="#ffffff" onchange="changeAttribute(this,'title','background')"/></div>
  <div><label class="db fw6 lh-copy f6" for="back_file"> Foreground</label>
  <input type="color" value="#000000" onchange="changeAttribute(this,'title','color')"/></div>
  <div><label class="db fw6 lh-copy f6" for="back_file"> Width</label>
  <input type="text" value="20mm" onchange="changeAttribute(this,'title','width')"/></div>
  </div>
  <div class="dtc">
  <div><label class="db fw6 lh-copy f6" for="back_file"> Line Size</label>
  <input type="text" value="20mm" onchange="changeAttribute(this,'title','line-height')"/></div>
  <div><label class="db fw6 lh-copy f6" for="back_file"> Font Size</label>
  <input type="text" value="15mm" onchange="changeAttribute(this,'title','font-size')"/></div>
  <div><label class="db fw6 lh-copy f6" for="back_file"> Font</label>
    <select class="f6" id="selectFontFamily" name="selectFontFamily" onchange="updateFontfamily(this)">
      <option> Serif </option>
      <option> Sans-Serif </option>
      <option> Monospace </option>
      <option> Tahoma </option>
      <option> Verdana </option>
      <option> Lucida Sans Unicode </option>
      <option style="font-family: Arial">Arial</option>
      <option style="font-family: Arial Black">Arial Black</option>
      <option style="font-family: Calibri">Calibri</option>
      <option style="font-family: Comic Sans MS">Comic Sans MS</option>
      <option style="font-family: Courier new">courier new</option>
      <option style="font-family: Impact">Impact</option>
      <option style="font-family: Libre Baskerville">Libre Baskerville</option>
      <option style="font-family: Martel Sans">Martel Sans</option>
      <option style="font-family: Unifraktur Cook">Unifraktur Cook</option>
      <option> Other ...</option>
    </select>
  </div>
  <div><label class="db fw6 lh-copy f6" for="back_file"><a href="https://wordmark.it/" target="_blank">Other font</a></label>
  <input id="other_font" type="text" value="" onchange="loadFont(this)"/></div>
  </div>
  </div>
</fieldset>
<fieldset class="col measure" id="back-tab" style="display: none;">
  <legend class="f4 ph1">Back</legend>
  <div class="mt1">
  <label class="db fw6 lh-copy f6" for="back_file">Image</label>
  <input type="file" id="back_file" name="files[]" onchange="fileSelect(this,'back')"/></div>
  <div class="mv1"><label class="db fw6 lh-copy f6" for="back_bg">Background</label>
  <input type="color" id="back_bg" value="#ffffff" onchange="changeAttribute(this,'back','background')"/></div>
</fieldset>
</div>

<div id="info" style="display: none">
  <div id="hover" class="color-info">
    <div id="color-hover" class="color-preview"></div>
    hovering<br>
    <label for="rgb-hover">rgb</label> <input type="text" size="11" id="rgb-hover" name="rgb-hover"><br>
    <label for="hex-hover">hex</label> <input type="text" size="11" id="hex-hover" name="hex-hover">
  </div>
  <div id="zoomer">
    <div id="coord"></div>
    <canvas id="zoomed" style="max-width: initial; max-height: inherit;"></canvas>
    <canvas id="crosshair" width="11px" height="11px"></canvas>
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
<script>
// var back  = document.getElementById('back');
var title = document.getElementById('title');
// var front = document.getElementById('front');
// var canvas = document.getElementById('source');
// var ctx = canvas.getContext('2d');

// handle file selection. Update image
function fileSelect(tgt, dst) {
  var files = tgt.files; // FileList object
  for (var i = 0, f; f = files[i]; i++) {
    if (!f.type.match('image.*')) { // Only process image files.
      continue;
    }
    var reader = new FileReader();

    // Closure to capture the file information.
    reader.onload = (function(theFile) {
      return function(e) {
        let img = new Image();
        img.onload = function() {
          img.title =  escape(theFile.name);
          console.log(img.title, img.width, img.height);
          // document.getElementById(dst).appendChild(img);
          let c = document.getElementById(dst).getElementsByTagName("canvas")[0];
          c.width = img.width;
          c.height = img.height;
          c.getContext('2d').drawImage(img, 0, 0);
        };
        img.src = e.target.result;
      };
    })(f);
    reader.readAsDataURL(f);
  }
}

function loadFont(tgt) {
  var selector = document.getElementById("selectFontFamily");
  var family = selector.options[selector.selectedIndex].value;
  var fontName = tgt.value;
  console.log(fontName);
  if(fontName !="") {
    WebFont.load({ google: { families: [fontName] } });
    title.style.fontFamily = fontName;
  }
}

function changeAttribute(tgt, dst, attr) {
  var col = tgt.value;
  console.log(dst, attr, col)
  document.getElementById(dst).style[attr] = col;
}

function updateFontfamily(selector) {
  var family = selector.options[selector.selectedIndex].value;
	console.log(family);
  if(family==="Other ...") {
     fontName = document.getElementById("other_font").value
	console.log(fontName);
     if(fontName != "") {
	  console.log(WebFont.load({ google: { families: [fontName] } }));
	  title.style.fontFamily = fontName;
     }
  } else {
	title.style.fontFamily = family;
  }
}

function updateTitle(tgt) {
  title.innerHTML = tgt.value;
}

function showBlock(tgt, dst) {
  var doc = document.getElementById(dst);
  document.getElementById('back-tab').style.display = "none";
  document.getElementById('center-tab').style.display = "none";
  document.getElementById('front-tab').style.display = "none";
  doc.style.display = "block";
  tablinks = document.getElementsByClassName("w3-bar-item");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" w3-red", "");
  }
  tgt.className += " w3-red";
}

function openTab(tabName) {
  var x = document.getElementsByClassName("tab");
  for (var i = 0; i < x.length; i++) {
    x[i].style.display = "none";
  }
  document.getElementById(tabName).style.display = "block";
}

function componentToHex(c) {
  var hex = c.toString(16)
  return hex.length == 1 ? "0" + hex : hex
}

function rgbToHex(r, g, b) {
  return '#' + componentToHex(r) + componentToHex(g) + componentToHex(b)
}

function drawCrosshair(r, g, b) {
  var ctx = document.getElementById('crosshair').getContext('2d')
  ctx.strokeStyle = 'rgba(' + r + ',' + g + ',' + b + ',0.25)'
  ctx.beginPath()
  ctx.moveTo(5.5, 0)
  ctx.lineTo(5.5, 4)
  ctx.stroke()
  ctx.beginPath()
  ctx.moveTo(7, 5.5)
  ctx.lineTo(11, 5.5)
  ctx.stroke()
  ctx.beginPath()
  ctx.moveTo(5.5, 7)
  ctx.lineTo(5.5, 11)
  ctx.stroke()
  ctx.beginPath()
  ctx.moveTo(0, 5.5)
  ctx.lineTo(4, 5.5)
  ctx.stroke()
}


info = document.getElementById("info");
zoomed = document.getElementById('zoomed');
zoomer= document.getElementById("zoomer");
coord= document.getElementById("coord");
hex_hover= document.getElementById("hex-hover");
rgb_hover= document.getElementById("rgb-hover");
color_hover= document.getElementById("color-hover");
ztx = zoomed.getContext('2d');

// “Update details” button opens the <dialog> modally
function createImage(canvas_id) {
  // info.onmouseleave = function() {
  //   $(this).find('input').blur()
  // };

  const zoom = 3;
  var canvas = document.getElementById(canvas_id);
  var ctx = canvas.getContext('2d');
  let img = new Image()
img.onload = function() {
  zoomed.width = img.width * zoom
  zoomed.height = img.height * zoom
  ztx.imageSmoothingEnabled = false
  ztx.mozImageSmoothingEnabled = false
  ztx.webkitImageSmoothingEnabled = false
  // ztx.putImageData(img, 0, 0)
  ztx.drawImage(img, 0, 0, zoomed.width, zoomed.height)

  info.style.display = "block";

  canvas.onmousemove = function(e) {
    var x = e.offsetX/canvas.clientWidth *canvas.width,
	y = e.offsetY/canvas.clientHeight*canvas.height,
	d = ctx.getImageData(x, y, 1, 1).data,
	r = d[0], g = d[1], b = d[2],
	ir = 255 - r, ig = 255 - g, ib = 255 - b,
	hex = rgbToHex(r, g, b),
	inv = rgbToHex(ir, ig, ib);

    // console.log( x + ' x ' + y, hex);
    coord.innerHtml = x + ' x ' + y;
    coord.style.color= inv;
    hex_hover.value = hex;
    rgb_hover.value = r + ',' + g + ',' + b;
    color_hover.style.background= hex;

    zoomed.style.left= -(zoom * e.offsetX) + (zoomer.offsetWidth) / 2;
    zoomed.style.top = -(zoom * e.offsetX) + (zoomer.offsetHeight) / 2;
  console.log( -(zoom * e.offsetX) + (zoomer.offsetWidth) / 2,
	-(zoom * e.offsetX) + (zoomer.offsetHeight) / 2,
	zoom * e.offsetX, zoomer.offsetWidth,
	zoom * e.offsetX, zoomer.offsetHeight);

    drawCrosshair(ir, ig, ib)
  };
}
  img.src=canvas.toDataURL()
}
</script>
</body>
</html>
